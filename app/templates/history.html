{% extends 'base.html' %}

{% block title %}分析历史 - CodeInsight{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>分析历史记录</h2>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回首页
        </a>
    </div>

    {% if history_list %}
    <div class="card">
        <div class="card-header bg-light">
            <div class="row fw-bold">
                <div class="col-md-1">#</div>
                <div class="col-md-5">仓库</div>
                <div class="col-md-2">语言</div>
                <div class="col-md-2">分析时间</div>
                <div class="col-md-2">操作</div>
            </div>
        </div>
        <ul class="list-group list-group-flush">
            {% for item in history_list %}
            <li class="list-group-item">
                <div class="row align-items-center">
                    <div class="col-md-1">{{ loop.index }}</div>
                    <div class="col-md-5">
                        <strong>{{ item.repo_url }}</strong>
                        {% if item.status == 'completed' %}
                        <span class="badge bg-success ms-2">完成</span>
                        {% elif item.status == 'failed' %}
                        <span class="badge bg-danger ms-2">失败</span>
                        {% else %}
                        <span class="badge bg-warning ms-2">{{ item.status }}</span>
                        {% endif %}
                    </div>
                    <div class="col-md-2">{{ item.language }}</div>
                    <div class="col-md-2">{{ item.created_at | datetime_format }}</div>
                    <div class="col-md-2">
                        {% if item.status == 'completed' %}
                        <a href="{{ url_for('main.report', task_id=item.id) }}" class="btn btn-sm btn-primary">
                            查看报告
                        </a>
                        {% elif item.status in ['initializing', 'cloning', 'cloned', 'analyzing', 'enhancing'] %}
                        <a href="{{ url_for('main.analysis_progress', task_id=item.id) }}" class="btn btn-sm btn-info">
                            查看进度
                        </a>
                        {% else %}
                        <a href="{{ url_for('main.analysis_progress', task_id=item.id) }}" class="btn btn-sm btn-secondary">
                            查看详情
                        </a>
                        {% endif %}
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    {% if pagination %}
    <nav aria-label="分页导航" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('main.history', page=page-1) if page > 1 else '#' }}">上一页</a>
            </li>
            
            {% for p in range(1, pagination.pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('main.history', page=p) }}">{{ p }}</a>
                </li>
            {% endfor %}
            
            <li class="page-item {% if page >= pagination.pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('main.history', page=page+1) if page < pagination.pages else '#' }}">下一页</a>
            </li>
        </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i> 暂无分析历史记录
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %} 